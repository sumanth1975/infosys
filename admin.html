<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Prediction History</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>
body {
    margin: 0;
    font-family: 'Montserrat', sans-serif;
    background: #f6f5f7;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 30px;
    background: linear-gradient(90deg, #ff4b5c, #ff416c);
    color: white;
}

.top-bar h2 {
    margin: 0;
    font-size: 22px;
}

.top-actions button {
    margin-left: 10px;
    padding: 8px 18px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    font-weight: 600;
}

.container {
    padding: 30px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

thead {
    background: #f1f1f1;
}

th, td {
    padding: 14px;
    text-align: center;
    border-bottom: 1px solid #eee;
    font-size: 14px;
}

.fake { color: #dc3545; font-weight: 700; }
.real { color: #28a745; font-weight: 700; }

.promote {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
}

.demote {
    background: #ff9800;
    color: white;
    border: none;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
}
/* ===== TOP ACTION BUTTONS (RESTORED COLORS) ===== */

.btn-dashboard {
    background: white;
    color: #ff4b2b;
}

.btn-download {
    background: white;
    color: #28a745;
}

.btn-logout {
    background: white;
    color: #dc3545;
}

.top-actions button:hover {
    opacity: 0.85;
    transform: scale(1.05);
}
.stats-title {
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 25px;
    text-align: center;
    color: #333;
}

/* ===== CHART CONTAINER ===== */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-top: 25px;
}

/* ===== CHART CARD ===== */
.chart-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 16px;
  height: 260px;              /* ðŸ”‘ FIX */
  box-shadow: 0 10px 28px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== CANVAS FIX ===== */
.chart-card canvas {
  width: 100% !important;
  height: 100% !important;
}

#adminStatsCharts .chart-card {
  height: 300px;
  max-width: 520px;
  margin: auto;
}



</style>
</head>

<body>

<div class="top-bar">
    <h2>Prediction History (Admin)</h2>
    <div class="top-actions">
    <button class="btn-dashboard" onclick="goDashboard()">Dashboard</button>
    <button class="btn-download" onclick="downloadHistory()">Download</button>
    <button class="btn-logout" onclick="logout()">Logout</button>
    <button class="btn-dashboard" onclick="showAdminStats()">Stats</button>

</div>

</div>

<div class="container">
    <div id="adminStatsCharts" style="display:none; margin-bottom:40px;">

  <h2 class="stats-title">Admin Analytics</h2>

  <div class="charts-grid">
    <div class="chart-card">
      <canvas id="adminPieChart"></canvas>
    </div>

    <div class="chart-card">
      <canvas id="adminBarChart"></canvas>
    </div>
  </div>

</div>

    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Type</th>
                <th>Title</th>
                <th>Result</th>
                <th>Confidence</th>
                <th>Date</th>
                <th>Time</th>
                <th>Role Action</th>
                <th style="min-width:120px;">
  Feedback
  <div id="flaggedCount" style="
    margin-top:6px;
    font-size:20px;
    font-weight:800;
    color:#dc3545;
  ">
    0
  </div>

  <button
    id="retrainBtn"
    onclick="retrainModel()"
    style="
      display:none;
      margin-top:6px;
      padding:4px 10px;
      font-size:12px;
      border:none;
      border-radius:12px;
      background:#673ab7;
      color:white;
      cursor:pointer;
    "
  >
    Retrain Model
  </button>
</th>

            </tr>
        </thead>
        <tbody id="historyBody">
            <tr><td colspan="8">Loading...</td></tr>
        </tbody>

    </table>
</div>

<script>
    let adminStatsVisible = false;
let adminPie = null;
let adminBar = null;

// ==========================
// ADMIN INITIALIZATION
// ==========================
const user = JSON.parse(localStorage.getItem("user"));

console.log("ADMIN USER:", user);

if (!user || user.role !== "admin") {
    alert("Admin access only");
    window.location.href = "index.html";
}

// ==========================
// LOAD ADMIN HISTORY
// ==========================
function loadHistory() {

    fetch("http://127.0.0.1:5000/admin/history", {

        method: "GET",
        headers: {
            Authorization: "Bearer " + localStorage.getItem("token")

        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error("HTTP " + res.status);
        }
        return res.json();
    })
    .then(res => {

        console.log("ADMIN API RESPONSE:", res);

        const tbody = document.getElementById("historyBody");
        tbody.innerHTML = "";

        if (!res.success || !res.data || res.data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8">No data found</td></tr>`;
            return;
        }

        res.data.forEach(row => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
        <td>${row.name}</td>
        <td>${row.email}</td>
        <td>${row.source.toUpperCase()}</td>
        <td>${row.title}</td>
        <td class="${row.prediction === 'Fake' ? 'fake' : 'real'}">
            ${row.prediction}
        </td>
        <td>${row.confidence}%</td>
        <td>${row.date}</td>
        <td>${row.time}</td>
        <td>${roleButtons(row)}</td>
        <td>
      ${
        row.feedback_status === 'flagged'
          ? '<span style="color:red;font-weight:bold">FLAGGED</span>'
          : '<span style="color:green;font-weight:600">OK</span>'
      }
    </td>
    `;

    tbody.appendChild(tr);
});

    })
    .catch(err => {
        console.error("ADMIN LOAD ERROR:", err);
        document.getElementById("historyBody").innerHTML =
            `<tr><td colspan="8">Failed to load data</td></tr>`;
    });
}

// ==========================
// ROLE ACTIONS
// ==========================
function roleButtons(row) {
    if (row.user_id == user.id) {
        return "<small>You</small>";
    }

    if (row.role === "admin") {
        return `<button class="demote" onclick="demoteUser(${row.user_id})">Demote</button>`;
    }
    return `<button class="promote" onclick="promoteUser(${row.user_id})">Promote</button>`;
}

function promoteUser(id) {
    fetch(`http://127.0.0.1:5000/admin/promote/${id}`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("token")
        }
    }).then(loadHistory);
}


function demoteUser(id) {
    fetch(`http://127.0.0.1:5000/admin/demote/${id}`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("token")
        }
    }).then(loadHistory);
}

function showAdminStats() {

  const box = document.getElementById("adminStatsCharts");

  // TOGGLE VISIBILITY
  if (adminStatsVisible) {
    box.style.display = "none";
    adminStatsVisible = false;
    return;
  }

  box.style.display = "block";
  adminStatsVisible = true;

  // â›” Charts already created â†’ stop
  if (adminPie || adminBar) return;

  fetch("/admin/statistics", {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(data => {

    // â³ wait till element is visible
    setTimeout(() => {

      adminPie = new Chart(
        document.getElementById("adminPieChart"),
        {
          type: "doughnut",
          data: {
            labels: ["Fake", "Real"],
            datasets: [{
              data: [data.stats.fake, data.stats.real],
              backgroundColor: ["#ff5252", "#4caf50"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" }
            }
          }
        }
      );

      adminBar = new Chart(
        document.getElementById("adminBarChart"),
        {
          type: "bar",
          data: {
            labels: data.daily.labels,
            datasets: [{
              label: "Daily Predictions",
              data: data.daily.counts,
              backgroundColor: "#3f51b5"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true }
            }
          }
        }
      );

    }, 120);
  });
}

function goDashboard() {
    window.location.href = "dashboard.html";
}

function logout() {
    localStorage.clear();
    window.location.href = "index.html";
}

function loadFlaggedCount() {
  fetch("http://127.0.0.1:5000/admin/statistics", {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById("flaggedCount").innerText =
  data.stats.flagged ?? 0;

    }
  });
}
function loadFlaggedAndRetrain() {
  fetch("http://127.0.0.1:5000/admin/statistics", {
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) return;

    const flagged = data.stats?.flagged ?? 0;

    document.getElementById("flaggedCount").innerText = flagged;

    // âœ… SHOW BUTTON ONLY IF > 20
    if (flagged > 20) {
      document.getElementById("retrainBtn").style.display = "inline-block";
    } else {
      document.getElementById("retrainBtn").style.display = "none";
    }
  });
}
function retrainModel() {
  if (!confirm("Retrain model now? This may take a few minutes.")) return;

  fetch("http://127.0.0.1:5000/admin/retrain-model", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    loadFlaggedAndRetrain(); // refresh state
  })
  .catch(() => alert("Retrain failed"));
}


// ==========================
// INITIAL LOAD
// ==========================
loadHistory();
loadFlaggedCount();
loadFlaggedAndRetrain();

</script>

</body>
</html>
